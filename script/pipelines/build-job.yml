parameters:
  - name: IsReleaseBuild
    type: boolean
    default: false
  - name: IsWindows
    type: boolean
    default: false
  - name: RunRustTests
    type: boolean
    default: true
  - name: RunGoTests
    type: boolean
    default: true
  - name: VendorForGo
    type: boolean
    default: true

steps:
  - task: GoTool@0
    displayName: "Install Go"
    inputs:
      version: $(GO_VERSION)

  - task: UsePythonVersion@0
    inputs:
      versionSpec: $(PY_PYTHON)
      addToPath: true
    displayName: "Use Python $(PY_PYTHON)"

  - script: rustup target add $(CARGO_BUILD_TARGET)
    displayName: "Install Rust"

  - task: Cache@2
    inputs:
      key: '"cargo-registry" | "$(Agent.OS)" | Cargo.lock'
      ${{ if eq(parameters.IsWindows, true )}}:
        path: $(UserProfile)/.cargo/registry
      ${{ if eq(parameters.IsWindows, false )}}:
        path: $(HOME)/.cargo/registry
    displayName: "Restore Cargo Registry Cache"

  - task: Cache@2
    inputs:
      key: '"cargo" | "$(Agent.OS)" | Cargo.lock'
      path: $(Build.SourcesDirectory)/target
    displayName: "Restore Cargo Build Cache"

  - ${{ if eq(parameters.IsWindows, true) }}:
      - powershell: script/bootstrap.ps1
        displayName: "Bootstrap Repo"
      - bash: |
          pacman -S mingw-w64-x86_64-binutils
        displayName: "Install GNU/Windows-specific dependencies"
  - ${{ if eq(parameters.IsWindows, false) }}:
      - bash: script/bootstrap
        displayName: "Bootstrap Repo"

  - bash: make engine
    displayName: "Build Client Engine"

  - bash: make _print-native-libraries
    displayName: "Detect Native Libraries required by engine"

    # Publish the artifacts now because a) we might as well have them even if the tests fail and b) 'make superclean' below will delete them
  - ${{ if eq(parameters.IsReleaseBuild, true) }}:
      - publish: artifacts/$(CARGO_BUILD_TARGET)/release
        condition: eq(parameters.ReleaseBuild, true)
        displayName: "Publish Standard Build"
        artifact: "$(CONFIGURATION)_$(CARGO_BUILD_TARGET)"

  - ${{ if eq(parameters.RunRustTests, true) }}:
      - bash: make test_rust
        displayName: "Run Rust tests"

  - ${{ if eq(parameters.RunGoTests, true) }}:
      - bash: |
          go clean -cache
          make test_go LIBRARY_MODE=shared
        displayName: "Run Go tests (Shared library)"

  - ${{ if eq(parameters.VendorForGo, true) }}:
    - bash: |
        make vendor CONFIGURATION=vendored
      displayName: "Build vendored library"

  - ${{ if eq(parameters.RunGoTests, true) }}:
      - bash: |
          # We should now be able to clean the build artifacts and the tests should use the vendored copy
          make superclean

          # We can now run tests with no build tags, which should run them against the vendored copy.
          go -C ./go/azcosmoscx test -v ./...
        displayName: "Run Go tests (Vendored static library)"

    # Published the vendored copy (for committing to the Go package) separately
  - ${{ if and(eq(parameters.VendorForGo, true), eq(parameters.IsReleaseBuild, true)) }}:
      - publish: go/azcosmoscx/libcosmoscx-vendor/$(CARGO_BUILD_TARGET)
        condition: eq(parameters.ReleaseBuild, true)
        displayName: "Publish Vendored Build"
        artifact: "vendored_$(CARGO_BUILD_TARGET)"
